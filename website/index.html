<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Benford's Law Testing Lab</title>
<style>
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

:root {
  --bg-primary: #0f0f1e;
  --bg-secondary: #1a1a2e;
  --bg-tertiary: #16213e;
  --bg-card: #1e1e36;
  --bg-hover: #252547;
  --bg-detail: #141428;
  --border: #2a2a4a;
  --border-light: #3a3a5a;
  --text-primary: #e8e8f0;
  --text-secondary: #a0a0c0;
  --text-muted: #6a6a8a;
  --green: #4CAF50;
  --green-dim: #2e6b30;
  --orange: #FF9800;
  --orange-dim: #8a5200;
  --red: #f44336;
  --red-dim: #8b2520;
  --purple: #9C27B0;
  --purple-dim: #5c1769;
  --cyan: #00BCD4;
  --cyan-dim: #00838F;
  --blue: #42A5F5;
  --accent: #7c4dff;
}

html { font-size: 15px; }

body {
  font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, 'Helvetica Neue', Arial, sans-serif;
  background: var(--bg-primary);
  color: var(--text-primary);
  line-height: 1.5;
  min-height: 100vh;
}

a { color: var(--blue); text-decoration: none; }
a:hover { text-decoration: underline; }

/* ---- HEADER ---- */
.header {
  background: linear-gradient(135deg, var(--bg-secondary) 0%, var(--bg-tertiary) 100%);
  border-bottom: 1px solid var(--border);
  padding: 2rem 2.5rem 1.5rem;
}
.header-inner { max-width: 1600px; margin: 0 auto; }
.header h1 {
  font-size: 1.75rem;
  font-weight: 700;
  letter-spacing: -0.02em;
  color: #fff;
}
.header h1 span { color: var(--accent); }
.header .subtitle {
  color: var(--text-secondary);
  font-size: 0.93rem;
  margin-top: 0.25rem;
}
.progress-wrap {
  margin-top: 1rem;
  display: flex;
  align-items: center;
  gap: 0.75rem;
}
.progress-bar-bg {
  flex: 1;
  max-width: 400px;
  height: 8px;
  background: var(--bg-primary);
  border-radius: 4px;
  overflow: hidden;
}
.progress-bar-fill {
  height: 100%;
  background: linear-gradient(90deg, var(--accent), var(--blue));
  border-radius: 4px;
  transition: width 0.6s ease;
  width: 0%;
}
.progress-label {
  font-size: 0.82rem;
  color: var(--text-muted);
  font-variant-numeric: tabular-nums;
}
.refresh-btn {
  margin-left: auto;
  background: var(--bg-card);
  border: 1px solid var(--border);
  color: var(--text-secondary);
  padding: 0.4rem 1rem;
  border-radius: 6px;
  cursor: pointer;
  font-size: 0.82rem;
  transition: background 0.15s, color 0.15s;
  display: flex;
  align-items: center;
  gap: 0.4rem;
}
.refresh-btn:hover { background: var(--bg-hover); color: var(--text-primary); }
.refresh-btn .spin { display: inline-block; transition: transform 0.3s; }
.refresh-btn.loading .spin { animation: spin 0.8s linear infinite; }
@keyframes spin { to { transform: rotate(360deg); } }

/* ---- MAIN CONTAINER ---- */
.container { max-width: 1600px; margin: 0 auto; padding: 1.5rem 2.5rem 3rem; }

/* ---- STAT CARDS ---- */
.stats-row {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 1rem;
  margin-bottom: 1.5rem;
}
.stat-card {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: 10px;
  padding: 1.1rem 1.3rem;
  display: flex;
  align-items: center;
  gap: 1rem;
  transition: transform 0.15s, box-shadow 0.15s;
}
.stat-card:hover { transform: translateY(-2px); box-shadow: 0 4px 20px rgba(0,0,0,0.3); }
.stat-icon {
  width: 44px; height: 44px;
  border-radius: 10px;
  display: flex; align-items: center; justify-content: center;
  font-size: 1.3rem;
  flex-shrink: 0;
}
.stat-card.conforms .stat-icon { background: rgba(76,175,80,0.15); color: var(--green); }
.stat-card.explained .stat-icon { background: rgba(66,165,245,0.15); color: var(--blue); }
.stat-card.has-mass .stat-icon { background: rgba(0,188,212,0.15); color: var(--cyan); }
.stat-card.marginal .stat-icon { background: rgba(255,152,0,0.15); color: var(--orange); }
.stat-count { font-size: 1.7rem; font-weight: 700; font-variant-numeric: tabular-nums; }
.stat-label { font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.08em; color: var(--text-muted); font-weight: 600; }
.stat-card.conforms .stat-count { color: var(--green); }
.stat-card.explained .stat-count { color: var(--blue); }
.stat-card.has-mass .stat-count { color: var(--cyan); }
.stat-card.marginal .stat-count { color: var(--orange); }

/* ---- CATEGORY FILTERS ---- */
.filters {
  display: flex;
  flex-wrap: wrap;
  gap: 0.45rem;
  margin-bottom: 1.25rem;
  padding-bottom: 1rem;
  border-bottom: 1px solid var(--border);
}
.filter-pill {
  background: var(--bg-card);
  border: 1px solid var(--border);
  color: var(--text-secondary);
  padding: 0.35rem 0.9rem;
  border-radius: 20px;
  cursor: pointer;
  font-size: 0.8rem;
  font-weight: 500;
  transition: all 0.15s;
  user-select: none;
}
.filter-pill:hover { background: var(--bg-hover); color: var(--text-primary); }
.filter-pill.active {
  background: var(--accent);
  border-color: var(--accent);
  color: #fff;
}

/* ---- TABLE ---- */
.table-wrap {
  overflow-x: auto;
  border: 1px solid var(--border);
  border-radius: 10px;
  background: var(--bg-card);
}
table { width: 100%; border-collapse: collapse; font-size: 0.87rem; }
thead th {
  background: var(--bg-tertiary);
  color: var(--text-secondary);
  font-weight: 600;
  font-size: 0.75rem;
  text-transform: uppercase;
  letter-spacing: 0.06em;
  padding: 0.75rem 0.9rem;
  text-align: left;
  white-space: nowrap;
  cursor: pointer;
  user-select: none;
  border-bottom: 1px solid var(--border);
  position: relative;
}
thead th:hover { color: var(--text-primary); }
thead th .sort-arrow {
  margin-left: 0.3rem;
  font-size: 0.65rem;
  opacity: 0.3;
}
thead th.sorted .sort-arrow { opacity: 1; color: var(--accent); }
tbody tr {
  border-bottom: 1px solid var(--border);
  cursor: pointer;
  transition: background 0.1s;
}
tbody tr:last-child { border-bottom: none; }
tbody tr:hover { background: var(--bg-hover); }
tbody tr.expanded { background: var(--bg-hover); }
td { padding: 0.7rem 0.9rem; white-space: nowrap; font-variant-numeric: tabular-nums; }

/* Status dot */
.dot {
  width: 10px; height: 10px;
  border-radius: 50%;
  display: inline-block;
}
.dot.conforms { background: var(--green); box-shadow: 0 0 6px rgba(76,175,80,0.5); }
.dot.explained { background: var(--blue); box-shadow: 0 0 6px rgba(66,165,245,0.5); }
.dot.has-mass { background: var(--cyan); box-shadow: 0 0 6px rgba(0,188,212,0.5); }
.dot.marginal { background: var(--orange); box-shadow: 0 0 6px rgba(255,152,0,0.5); }

/* Badges */
.badge {
  display: inline-block;
  padding: 0.15rem 0.55rem;
  border-radius: 4px;
  font-size: 0.73rem;
  font-weight: 600;
  letter-spacing: 0.03em;
}
.badge-conforms { background: rgba(76,175,80,0.15); color: var(--green); }
.badge-explained { background: rgba(66,165,245,0.15); color: var(--blue); }
.badge-has-mass { background: rgba(0,188,212,0.15); color: var(--cyan); }
.badge-marginal { background: rgba(255,152,0,0.15); color: var(--orange); }
.badge-queued { background: rgba(120,120,140,0.15); color: var(--text-muted); }
.badge-insufficient { background: rgba(255,152,0,0.1); color: #c88c00; }
.badge-error { background: rgba(244,67,54,0.1); color: var(--red); }
.badge-in-progress { background: rgba(66,165,245,0.15); color: var(--blue); }

.dot.queued { background: #444; box-shadow: none; }
.dot.insufficient { background: #c88c00; box-shadow: 0 0 6px rgba(200,140,0,0.3); }
.dot.error { background: var(--red); opacity: 0.6; }
.dot.in-progress { background: var(--blue); box-shadow: 0 0 6px rgba(66,165,245,0.5); }

tr.row-incomplete td { opacity: 0.55; }
tr.row-incomplete:hover td { opacity: 0.85; }

.badge-cat {
  display: inline-block;
  padding: 0.15rem 0.5rem;
  border-radius: 4px;
  font-size: 0.73rem;
  font-weight: 500;
  background: rgba(124,77,255,0.1);
  color: var(--accent);
}

.val-green { color: var(--green); }
.val-orange { color: var(--orange); }
.val-red { color: var(--red); }

/* ---- DETAIL PANEL ---- */
.detail-row td { padding: 0; }
.detail-panel {
  background: var(--bg-detail);
  padding: 1.5rem 2rem;
  border-top: 1px solid var(--border-light);
}
.detail-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 1.5rem;
}
.detail-section h3 {
  font-size: 0.85rem;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.06em;
  color: var(--text-muted);
  margin-bottom: 0.75rem;
  padding-bottom: 0.4rem;
  border-bottom: 1px solid var(--border);
}
.detail-section { margin-bottom: 0.5rem; }

/* Chart area */
.chart-container {
  background: var(--bg-secondary);
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 1rem;
}
.chart-bars {
  display: flex;
  align-items: flex-end;
  gap: 0;
  height: 180px;
  padding-top: 0.5rem;
}
.chart-bar-group {
  flex: 1;
  display: flex;
  flex-direction: column;
  align-items: center;
  height: 100%;
  position: relative;
}
.chart-bar-area {
  flex: 1;
  width: 100%;
  display: flex;
  align-items: flex-end;
  justify-content: center;
  gap: 2px;
  position: relative;
}
.bar-observed {
  width: 40%;
  border-radius: 3px 3px 0 0;
  transition: height 0.4s ease;
  min-height: 1px;
}
.bar-expected {
  width: 40%;
  border: 2px solid rgba(255,255,255,0.25);
  border-bottom: none;
  border-radius: 3px 3px 0 0;
  background: transparent;
  transition: height 0.4s ease;
  min-height: 1px;
}
.chart-digit-label {
  font-size: 0.75rem;
  color: var(--text-muted);
  margin-top: 0.3rem;
  font-weight: 600;
}
.chart-legend {
  display: flex;
  gap: 1.2rem;
  justify-content: center;
  margin-top: 0.75rem;
  font-size: 0.73rem;
  color: var(--text-secondary);
}
.legend-swatch {
  display: inline-block;
  width: 12px; height: 12px;
  border-radius: 2px;
  margin-right: 0.3rem;
  vertical-align: middle;
}
.legend-swatch.observed { background: var(--blue); }
.legend-swatch.expected { border: 2px solid rgba(255,255,255,0.25); background: transparent; }

/* Deviation chart */
.dev-bars {
  display: flex;
  align-items: center;
  height: 120px;
  position: relative;
}
.dev-bar-group {
  flex: 1;
  display: flex;
  flex-direction: column;
  align-items: center;
  height: 100%;
  position: relative;
}
.dev-bar-area {
  flex: 1;
  width: 100%;
  display: flex;
  align-items: center;
  justify-content: center;
  position: relative;
}
.dev-bar {
  width: 55%;
  border-radius: 3px;
  transition: height 0.4s ease;
  position: absolute;
}
.dev-bar.positive {
  bottom: 50%;
  background: var(--green);
  border-radius: 3px 3px 0 0;
}
.dev-bar.negative {
  top: 50%;
  background: var(--red);
  border-radius: 0 0 3px 3px;
}
.dev-zero-line {
  position: absolute;
  left: 0; right: 0;
  top: 50%;
  border-top: 1px dashed var(--border-light);
}

/* Stats table inside detail */
.stats-detail-table { width: 100%; font-size: 0.82rem; }
.stats-detail-table td {
  padding: 0.4rem 0.6rem;
  border-bottom: 1px solid var(--border);
  white-space: normal;
}
.stats-detail-table tr:last-child td { border-bottom: none; }
.stats-detail-table .stat-name { color: var(--text-muted); font-weight: 500; width: 45%; }
.stats-detail-table .stat-val { font-weight: 600; font-variant-numeric: tabular-nums; }

.notes-text {
  font-size: 0.85rem;
  color: var(--text-secondary);
  line-height: 1.6;
  white-space: pre-wrap;
}
.source-text { font-size: 0.82rem; color: var(--text-muted); }

/* ---- EMPTY / ERROR STATE ---- */
.empty-state {
  text-align: center;
  padding: 4rem 2rem;
  color: var(--text-muted);
}
.empty-state .icon { font-size: 3rem; margin-bottom: 1rem; opacity: 0.4; }
.empty-state h2 { font-size: 1.3rem; color: var(--text-secondary); margin-bottom: 0.5rem; }
.empty-state p { font-size: 0.9rem; }

.detail-error {
  text-align: center;
  padding: 2rem;
  color: var(--red);
  font-size: 0.9rem;
}

/* ---- LAST UPDATED ---- */
.last-updated {
  text-align: right;
  font-size: 0.72rem;
  color: var(--text-muted);
  margin-top: 0.75rem;
}

/* ---- RESPONSIVE ---- */
@media (max-width: 1100px) {
  .stats-row { grid-template-columns: repeat(3, 1fr); }
}
@media (max-width: 900px) {
  .stats-row { grid-template-columns: repeat(2, 1fr); }
  .detail-grid { grid-template-columns: 1fr; }
  .header { padding: 1.5rem 1.2rem 1rem; }
  .container { padding: 1rem 1.2rem 2rem; }
}
@media (max-width: 600px) {
  .stats-row { grid-template-columns: 1fr; }
}
</style>
</head>
<body>

<!-- HEADER -->
<header class="header">
  <div class="header-inner">
    <h1><span>Benford's Law</span> Testing Lab</h1>
    <p class="subtitle" id="subtitle">Companion to &ldquo;The Law of Emergence&rdquo; &mdash; Riner (2026) &bull; DOI: 10.5281/zenodo.18510250</p>
    <div class="progress-wrap">
      <div class="progress-bar-bg"><div class="progress-bar-fill" id="progressFill"></div></div>
      <span class="progress-label" id="progressLabel">0 / 76 tests completed</span>
      <a href="figures.html" style="margin-left:0.5rem;background:var(--bg-card);border:1px solid var(--border);color:var(--text-secondary);padding:0.4rem 1rem;border-radius:6px;font-size:0.82rem;display:flex;align-items:center;gap:0.4rem;text-decoration:none;transition:background 0.15s,color 0.15s;" onmouseover="this.style.background='var(--bg-hover)';this.style.color='var(--text-primary)'" onmouseout="this.style.background='var(--bg-card)';this.style.color='var(--text-secondary)'" >&#x1F52D; Round-Trip Figures</a>
      <button class="refresh-btn" id="refreshBtn" onclick="manualRefresh()">
        <span class="spin">&#x21bb;</span> Refresh
      </button>
    </div>
  </div>
</header>

<!-- MAIN -->
<div class="container">

  <!-- STAT CARDS -->
  <div class="stats-row">
    <div class="stat-card conforms">
      <div class="stat-icon">&#x2714;</div>
      <div><div class="stat-count" id="statConforms">0</div><div class="stat-label">Conforms</div></div>
    </div>
    <div class="stat-card explained">
      <div class="stat-icon">&#x2139;</div>
      <div><div class="stat-count" id="statExplained">0</div><div class="stat-label">Explained</div></div>
    </div>
    <div class="stat-card has-mass">
      <div class="stat-icon">&#x2B24;</div>
      <div><div class="stat-count" id="statHasMass">0</div><div class="stat-label">Has Mass</div></div>
    </div>
    <div class="stat-card marginal">
      <div class="stat-icon">&#x25B2;</div>
      <div><div class="stat-count" id="statMarginal">0</div><div class="stat-label">Marginal</div></div>
    </div>
  </div>

  <!-- CATEGORY FILTERS -->
  <div class="filters" id="filters"></div>

  <!-- TABLE -->
  <div class="table-wrap">
    <table id="resultsTable">
      <thead>
        <tr>
          <th data-key="verdict" data-type="string" style="width:40px;"><span class="sort-arrow">&#x25B2;</span></th>
          <th data-key="display_name" data-type="string">Test Name <span class="sort-arrow">&#x25B2;</span></th>
          <th data-key="category" data-type="string">Category <span class="sort-arrow">&#x25B2;</span></th>
          <th data-key="data_points" data-type="number">Data Points <span class="sort-arrow">&#x25B2;</span></th>
          <th data-key="verdict" data-type="string">Verdict <span class="sort-arrow">&#x25B2;</span></th>
          <th data-key="delta_b" data-type="number">&delta;<sub>B</sub> <span class="sort-arrow">&#x25B2;</span></th>
          <th data-key="mad" data-type="number">MAD <span class="sort-arrow">&#x25B2;</span></th>
          <th data-key="chi_squared_p" data-type="number">&chi;&sup2; p-value <span class="sort-arrow">&#x25B2;</span></th>
        </tr>
      </thead>
      <tbody id="tableBody"></tbody>
    </table>
  </div>

  <div id="emptyState" class="empty-state" style="display:none;">
    <div class="icon">&#x1F50D;</div>
    <h2>No results yet</h2>
    <p>Run some tests to see results here! The dashboard auto-refreshes every 30 seconds.</p>
  </div>

  <div class="last-updated" id="lastUpdated"></div>
</div>

<script>
(function() {
  "use strict";

  /* ========== STATE ========== */
  var summaryData = null;
  var queueData = null;
  var allTests = [];
  var filteredTests = [];
  var activeCategory = "All";
  var sortKey = "display_name";
  var sortAsc = true;
  var expandedTestId = null;
  var detailCache = {};
  var autoRefreshTimer = null;

  var CATEGORIES = ["All","Quantum Statistics"];

  var BENFORD_EXPECTED = [
    0.30103, 0.17609, 0.12494, 0.09691, 0.07918,
    0.06695, 0.05799, 0.05115, 0.04576
  ];

  /* ========== DOM REFS ========== */
  var $progressFill = document.getElementById("progressFill");
  var $progressLabel = document.getElementById("progressLabel");
  var $statConforms = document.getElementById("statConforms");
  var $statExplained = document.getElementById("statExplained");
  var $statHasMass = document.getElementById("statHasMass");
  var $statMarginal = document.getElementById("statMarginal");
  var $filters = document.getElementById("filters");
  var $tableBody = document.getElementById("tableBody");
  var $emptyState = document.getElementById("emptyState");
  var $lastUpdated = document.getElementById("lastUpdated");
  var $refreshBtn = document.getElementById("refreshBtn");
  var $subtitle = document.getElementById("subtitle");

  /* ========== HELPERS ========== */
  function verdictClass(v) {
    if (!v) return "conforms";
    var lower = v.toLowerCase();
    if (lower === "has mass") return "has-mass";
    return lower;
  }

  function statusDotClass(t) {
    if (t._status === "complete" && t.verdict) return verdictClass(t.verdict);
    if (t._status === "insufficient_data") return "insufficient";
    if (t._status === "error") return "error";
    if (t._status === "in_progress") return "in-progress";
    return "queued";
  }

  function statusBadge(t) {
    if (t._status === "complete" && t.verdict) {
      var vc = verdictClass(t.verdict);
      return '<span class="badge badge-' + vc + '">' + esc(t.verdict) + '</span>';
    }
    if (t._status === "insufficient_data") return '<span class="badge badge-insufficient">INSUFFICIENT DATA</span>';
    if (t._status === "error") return '<span class="badge badge-error">ERROR</span>';
    if (t._status === "in_progress") return '<span class="badge badge-in-progress">IN PROGRESS</span>';
    return '<span class="badge badge-queued">QUEUED</span>';
  }

  function colorForDelta(val) {
    if (val == null) return "";
    if (val < 0.03) return "val-green";
    if (val <= 0.06) return "val-orange";
    return "val-red";
  }

  function colorForMAD(val) {
    if (val == null) return "";
    if (val < 0.006) return "val-green";
    if (val <= 0.012) return "val-orange";
    return "val-red";
  }

  function colorForP(val) {
    if (val == null) return "";
    if (val > 0.05) return "val-green";
    if (val >= 0.01) return "val-orange";
    return "val-red";
  }

  function fmt(n, d) {
    if (n == null || n === undefined) return "--";
    return Number(n).toFixed(d !== undefined ? d : 4);
  }

  function esc(s) {
    if (!s) return "";
    var d = document.createElement("div");
    d.textContent = s;
    return d.innerHTML;
  }

  /* ========== FETCH ========== */
  function fetchData() {
    $refreshBtn.classList.add("loading");
    var p1 = fetch("../results/summary.json?_t=" + Date.now())
      .then(function(r) { return r.ok ? r.json() : null; })
      .catch(function() { return null; });
    var p2 = fetch("../data/test_queue.json?_t=" + Date.now())
      .then(function(r) { return r.ok ? r.json() : null; })
      .catch(function() { return null; });

    return Promise.all([p1, p2]).then(function(results) {
      summaryData = results[0];
      queueData = results[1];
      mergeData();
      render();
    }).finally(function() {
      $refreshBtn.classList.remove("loading");
    });
  }

  function mergeData() {
    allTests = [];

    /* Build lookup from summary results */
    var resultMap = {};
    if (summaryData && summaryData.tests) {
      summaryData.tests.forEach(function(t) { resultMap[t.test_id] = t; });
    }

    if (queueData && queueData.length > 0) {
      /* Merge queue with results */
      queueData.forEach(function(q) {
        var result = resultMap[q.test_id];
        if (result) {
          var entry = {};
          for (var k in result) { entry[k] = result[k]; }
          entry._status = "complete";
          entry.description = entry.description || q.description;
          entry.priority = q.priority;
          allTests.push(entry);
          delete resultMap[q.test_id];
        } else {
          allTests.push({
            test_id: q.test_id,
            display_name: q.display_name,
            category: q.category,
            description: q.description,
            _status: q.status || "queued",
            data_points: null,
            verdict: null,
            delta_b: null,
            mad: null,
            chi_squared_p: null,
            priority: q.priority
          });
        }
      });
      /* Any results not in queue (shouldn't happen, but just in case) */
      for (var id in resultMap) {
        var r = resultMap[id];
        r._status = "complete";
        allTests.push(r);
      }
    } else if (summaryData && summaryData.tests) {
      /* Fallback: just use summary data */
      summaryData.tests.forEach(function(t) {
        t._status = "complete";
        allTests.push(t);
      });
    }
  }

  function fetchDetail(testId) {
    if (detailCache[testId]) return Promise.resolve(detailCache[testId]);
    return fetch("../results/individual/" + encodeURIComponent(testId) + ".json?_t=" + Date.now())
      .then(function(r) {
        if (!r.ok) throw new Error("HTTP " + r.status);
        return r.json();
      })
      .then(function(data) {
        detailCache[testId] = data;
        return data;
      });
  }

  /* ========== RENDER ========== */
  function render() {
    if (allTests.length === 0) {
      renderEmpty();
      return;
    }
    $emptyState.style.display = "none";
    document.querySelector(".table-wrap").style.display = "";

    /* Count stats from completed tests */
    var completed = 0, conforms = 0, explained = 0, hasMass = 0, marginal = 0;
    allTests.forEach(function(t) {
      if (t._status === "complete") {
        completed++;
        var v = (t.verdict || "").toUpperCase();
        if (v === "CONFORMS") conforms++;
        else if (v === "EXPLAINED") explained++;
        else if (v === "HAS MASS") hasMass++;
        else if (v === "MARGINAL") marginal++;
      }
    });

    $statConforms.textContent = conforms;
    $statExplained.textContent = explained;
    $statHasMass.textContent = hasMass;
    $statMarginal.textContent = marginal;

    var total = allTests.length;
    var pct = Math.round((completed / total) * 100);
    $progressFill.style.width = pct + "%";
    $progressLabel.textContent = completed + " / " + total + " tests completed";
    if ($subtitle) $subtitle.textContent = "Testing " + total + " physical datasets against the Benford constraint \u2014 Riner (2026)";

    if (summaryData && summaryData.last_updated) {
      try {
        var d = new Date(summaryData.last_updated);
        $lastUpdated.textContent = "Last updated: " + d.toLocaleString();
      } catch(e) {
        $lastUpdated.textContent = "Last updated: " + summaryData.last_updated;
      }
    }

    renderFilters();
    applyFilterAndSort();
    renderTable();
  }

  function renderEmpty() {
    $emptyState.style.display = "";
    document.querySelector(".table-wrap").style.display = "none";
    $progressFill.style.width = "0%";
    $progressLabel.textContent = "0 / 0 tests completed";
    $lastUpdated.textContent = "";
  }

  function renderFilters() {
    $filters.innerHTML = "";
    var present = {};
    allTests.forEach(function(t) { if (t.category) present[t.category] = true; });
    CATEGORIES.forEach(function(cat) {
      var pill = document.createElement("span");
      pill.className = "filter-pill" + (cat === activeCategory ? " active" : "");
      pill.textContent = cat;
      if (cat !== "All" && !present[cat]) {
        pill.style.opacity = "0.4";
      }
      pill.addEventListener("click", function() {
        activeCategory = cat;
        applyFilterAndSort();
        renderFilters();
        renderTable();
      });
      $filters.appendChild(pill);
    });
  }

  function applyFilterAndSort() {
    filteredTests = allTests.filter(function(t) {
      if (activeCategory === "All") return true;
      return t.category === activeCategory;
    });
    filteredTests.sort(function(a, b) {
      /* Completed tests first, then sort by key */
      var aComplete = a._status === "complete" ? 0 : 1;
      var bComplete = b._status === "complete" ? 0 : 1;
      if (aComplete !== bComplete) return aComplete - bComplete;

      var va = a[sortKey], vb = b[sortKey];
      if (va == null && vb == null) return 0;
      if (va == null) return 1;
      if (vb == null) return -1;
      if (typeof va === "string") va = va.toLowerCase();
      if (typeof vb === "string") vb = vb.toLowerCase();
      if (va < vb) return sortAsc ? -1 : 1;
      if (va > vb) return sortAsc ? 1 : -1;
      return 0;
    });
  }

  function renderTable() {
    $tableBody.innerHTML = "";
    if (filteredTests.length === 0) {
      var tr = document.createElement("tr");
      tr.innerHTML = '<td colspan="8" style="text-align:center;color:var(--text-muted);padding:2rem;">No tests match this category filter.</td>';
      $tableBody.appendChild(tr);
      return;
    }

    filteredTests.forEach(function(t) {
      var isComplete = t._status === "complete";
      var dotCls = statusDotClass(t);
      var tr = document.createElement("tr");
      tr.dataset.testId = t.test_id;
      if (!isComplete) tr.classList.add("row-incomplete");
      if (expandedTestId === t.test_id) tr.classList.add("expanded");

      tr.innerHTML =
        '<td><span class="dot ' + dotCls + '"></span></td>' +
        '<td style="white-space:normal;min-width:200px;font-weight:500;">' + esc(t.display_name) + '</td>' +
        '<td><span class="badge-cat">' + esc(t.category) + '</span></td>' +
        '<td>' + (t.data_points != null ? Number(t.data_points).toLocaleString() : "--") + '</td>' +
        '<td>' + statusBadge(t) + '</td>' +
        '<td class="' + colorForDelta(t.delta_b) + '">' + fmt(t.delta_b) + '</td>' +
        '<td class="' + colorForMAD(t.mad) + '">' + fmt(t.mad) + '</td>' +
        '<td class="' + colorForP(t.chi_squared_p) + '">' + fmt(t.chi_squared_p) + '</td>';

      if (isComplete) {
        tr.addEventListener("click", function() { toggleDetail(t.test_id); });
        tr.style.cursor = "pointer";
      } else {
        tr.style.cursor = "default";
      }
      $tableBody.appendChild(tr);

      /* If expanded and complete, insert detail row */
      if (expandedTestId === t.test_id && isComplete) {
        var detailTr = document.createElement("tr");
        detailTr.className = "detail-row";
        detailTr.innerHTML = '<td colspan="8"><div class="detail-panel" id="detail-' + t.test_id + '"><p style="color:var(--text-muted);">Loading details...</p></div></td>';
        $tableBody.appendChild(detailTr);
        loadAndRenderDetail(t.test_id);
      }
    });
  }

  function toggleDetail(testId) {
    if (expandedTestId === testId) {
      expandedTestId = null;
    } else {
      expandedTestId = testId;
    }
    renderTable();
  }

  function loadAndRenderDetail(testId) {
    var container = document.getElementById("detail-" + testId);
    if (!container) return;
    fetchDetail(testId)
      .then(function(data) { renderDetail(container, data, testId); })
      .catch(function(err) {
        container.innerHTML = '<div class="detail-error">Failed to load detail data for this test. (' + esc(err.message) + ')</div>';
      });
  }

  /* ========== DETAIL RENDER ========== */
  function renderDetail(container, data, testId) {
    var html = '<div class="detail-grid">';

    /* Left column: charts */
    html += '<div>';
    html += '<div class="detail-section"><h3>Digit Distribution</h3>';
    html += renderDistChart(data);
    html += '</div>';
    html += '<div class="detail-section"><h3>Per-Digit Deviation</h3>';
    html += renderDeviationChart(data);
    html += '</div>';
    html += '</div>';

    /* Right column: stats & notes */
    html += '<div>';
    html += '<div class="detail-section"><h3>Statistical Tests</h3>';
    html += renderStatsTable(data);
    html += '</div>';

    var notes = data.notes || data.interesting_findings || "";
    if (notes) {
      html += '<div class="detail-section"><h3>Notes</h3>';
      html += '<div class="notes-text">' + esc(notes) + '</div>';
      html += '</div>';
    }

    var source = data.data_source || data.source || "";
    if (source) {
      html += '<div class="detail-section"><h3>Source</h3>';
      if (typeof source === "object") {
        html += '<div class="source-text">' + esc(source.description || source.name || JSON.stringify(source)) + '</div>';
      } else {
        html += '<div class="source-text">' + esc(source) + '</div>';
      }
      html += '</div>';
    }

    html += '</div></div>';
    container.innerHTML = html;
  }

  function getObserved(data) {
    var dd = data.digit_distribution || data.observed_distribution || {};
    var arr = [];
    for (var d = 1; d <= 9; d++) {
      arr.push(dd[d] || dd[String(d)] || 0);
    }
    return arr;
  }

  function getExpected(data) {
    var ed = data.expected_distribution || {};
    var arr = [];
    var hasData = false;
    for (var d = 1; d <= 9; d++) {
      var v = ed[d] || ed[String(d)];
      if (v != null) hasData = true;
      arr.push(v || 0);
    }
    return hasData ? arr : BENFORD_EXPECTED;
  }

  function getDeviation(data) {
    var dev = data.per_digit_deviation || {};
    var obs = getObserved(data);
    var exp = getExpected(data);
    var arr = [];
    for (var d = 1; d <= 9; d++) {
      var v = dev[d] || dev[String(d)];
      if (v != null) {
        arr.push(v);
      } else {
        arr.push(obs[d-1] - exp[d-1]);
      }
    }
    return arr;
  }

  function renderDistChart(data) {
    var obs = getObserved(data);
    var exp = getExpected(data);
    var maxVal = 0;
    for (var i = 0; i < 9; i++) {
      maxVal = Math.max(maxVal, obs[i], exp[i]);
    }
    if (maxVal === 0) maxVal = 0.35;

    var h = '<div class="chart-container"><div class="chart-bars">';
    for (var d = 0; d < 9; d++) {
      var obsPct = (obs[d] / maxVal) * 100;
      var expPct = (exp[d] / maxVal) * 100;
      h += '<div class="chart-bar-group">';
      h += '<div class="chart-bar-area">';
      h += '<div class="bar-observed" style="height:' + obsPct + '%;background:var(--blue);" title="Observed: ' + fmt(obs[d]) + '"></div>';
      h += '<div class="bar-expected" style="height:' + expPct + '%;" title="Expected: ' + fmt(exp[d]) + '"></div>';
      h += '</div>';
      h += '<div class="chart-digit-label">' + (d+1) + '</div>';
      h += '</div>';
    }
    h += '</div>';
    h += '<div class="chart-legend">';
    h += '<span><span class="legend-swatch observed"></span>Observed</span>';
    h += '<span><span class="legend-swatch expected"></span>Expected (Benford)</span>';
    h += '</div></div>';
    return h;
  }

  function renderDeviationChart(data) {
    var devs = getDeviation(data);
    var maxAbs = 0;
    for (var i = 0; i < 9; i++) {
      maxAbs = Math.max(maxAbs, Math.abs(devs[i]));
    }
    if (maxAbs === 0) maxAbs = 0.05;

    var h = '<div class="chart-container"><div class="dev-bars" style="position:relative;">';
    h += '<div class="dev-zero-line"></div>';
    for (var d = 0; d < 9; d++) {
      var pct = (Math.abs(devs[d]) / maxAbs) * 45;
      var cls = devs[d] >= 0 ? "positive" : "negative";
      h += '<div class="dev-bar-group">';
      h += '<div class="dev-bar-area">';
      h += '<div class="dev-bar ' + cls + '" style="height:' + pct + '%;" title="' + (devs[d] >= 0 ? "+" : "") + fmt(devs[d]) + '"></div>';
      h += '</div>';
      h += '<div class="chart-digit-label">' + (d+1) + '</div>';
      h += '</div>';
    }
    h += '</div>';
    h += '<div class="chart-legend">';
    h += '<span><span class="legend-swatch" style="background:var(--green);"></span>Over-represented</span>';
    h += '<span><span class="legend-swatch" style="background:var(--red);"></span>Under-represented</span>';
    h += '</div></div>';
    return h;
  }

  function renderStatsTable(data) {
    var rows = [];

    if (data.chi_squared) {
      var cs = data.chi_squared;
      rows.push(["Chi-squared statistic", fmt(cs.statistic || cs.chi2_statistic, 4)]);
      rows.push(["Chi-squared p-value", '<span class="' + colorForP(cs.p_value) + '">' + fmt(cs.p_value) + '</span>']);
    } else if (data.chi_squared_p != null) {
      rows.push(["Chi-squared p-value", '<span class="' + colorForP(data.chi_squared_p) + '">' + fmt(data.chi_squared_p) + '</span>']);
    }

    if (data.mad != null) {
      var madVal = (typeof data.mad === "object") ? data.mad.value : data.mad;
      var madClass = data.mad_classification || data.mad_interpret || "";
      rows.push(["MAD", '<span class="' + colorForMAD(madVal) + '">' + fmt(madVal) + '</span>' + (madClass ? ' <span style="color:var(--text-muted);">(' + esc(madClass) + ')</span>' : "")]);
    }

    if (data.ks_test) {
      var ks = data.ks_test;
      rows.push(["KS statistic", fmt(ks.statistic || ks.ks_statistic, 4)]);
      rows.push(["KS p-value", '<span class="' + colorForP(ks.p_value) + '">' + fmt(ks.p_value) + '</span>']);
    } else if (data.ks_p != null) {
      rows.push(["KS p-value", '<span class="' + colorForP(data.ks_p) + '">' + fmt(data.ks_p) + '</span>']);
    }

    if (data.delta_b != null) {
      var db = (typeof data.delta_b === "object") ? data.delta_b.value : data.delta_b;
      rows.push(["Delta-B (&delta;<sub>B</sub>)", '<span class="' + colorForDelta(db) + '">' + fmt(db) + '</span>']);
    }

    if (data.verdict) {
      var vc = verdictClass(data.verdict);
      rows.push(["Verdict", '<span class="badge badge-' + vc + '">' + esc(data.verdict) + '</span>']);
    }

    if (data.confidence) {
      rows.push(["Confidence", esc(data.confidence)]);
    }

    if (data.data_points || data.n) {
      rows.push(["Data points", Number(data.data_points || data.n).toLocaleString()]);
    }

    var h = '<table class="stats-detail-table">';
    rows.forEach(function(r) {
      h += '<tr><td class="stat-name">' + r[0] + '</td><td class="stat-val">' + r[1] + '</td></tr>';
    });
    h += '</table>';
    return h;
  }

  /* ========== SORTING ========== */
  document.querySelectorAll("thead th").forEach(function(th) {
    th.addEventListener("click", function(e) {
      e.stopPropagation();
      var key = th.dataset.key;
      if (!key) return;
      if (sortKey === key) {
        sortAsc = !sortAsc;
      } else {
        sortKey = key;
        sortAsc = true;
      }
      document.querySelectorAll("thead th").forEach(function(t) { t.classList.remove("sorted"); });
      th.classList.add("sorted");
      th.querySelector(".sort-arrow").innerHTML = sortAsc ? "&#x25B2;" : "&#x25BC;";
      applyFilterAndSort();
      renderTable();
    });
  });

  /* ========== REFRESH ========== */
  window.manualRefresh = function() {
    detailCache = {};
    fetchData();
  };

  function startAutoRefresh() {
    if (autoRefreshTimer) clearInterval(autoRefreshTimer);
    autoRefreshTimer = setInterval(function() { fetchData(); }, 30000);
  }

  /* ========== INIT ========== */
  renderFilters();
  fetchData();
  startAutoRefresh();

})();
</script>
</body>
</html>
